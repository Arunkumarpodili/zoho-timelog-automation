name: Zoho Daily Time Log

on:
  schedule:
    # 11:00 AM IST = 05:30 UTC
    - cron: "30 5 * * 2-6"
  workflow_dispatch:

jobs:
  zoho-time:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run Zoho Time Logger
        id: zoho
        env:
          ZOHO_CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          ZOHO_CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}
          ZOHO_REFRESH_TOKEN: ${{ secrets.ZOHO_REFRESH_TOKEN }}
          ZOHO_DC: ${{ secrets.ZOHO_DC }}
          ZOHO_PORTAL_ID: ${{ secrets.ZOHO_PORTAL_ID }}
          ZOHO_PROJECT_ID: ${{ secrets.ZOHO_PROJECT_ID }}
          ZOHO_TASK_ID: ${{ secrets.ZOHO_TASK_ID }}
          ZOHO_USER_ID: ${{ secrets.ZOHO_USER_ID }}
          ZOHO_BILL_STATUS: ${{ secrets.ZOHO_BILL_STATUS }}
          ZOHO_TIME_START: ${{ secrets.ZOHO_TIME_START }}
          ZOHO_TIME_END: ${{ secrets.ZOHO_TIME_END }}
          ZOHO_TIMEZONE: ${{ secrets.ZOHO_TIMEZONE }}
          ZOHO_NOTES_PREFIX: ${{ secrets.ZOHO_NOTES_PREFIX }}
        run: python Scripts/zoho_log_time.py

      - name: Send success email
        if: success()        # only if previous steps succeeded
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Zoho Time Log Success - ${{ github.repository }}"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          secure: true
          body: |
            Zoho time log job completed successfully.

            Repo:    ${{ github.repository }}
            Run ID:  ${{ github.run_id }}
            Date:    ${{ github.event_name == 'schedule' && 'Cron run' || 'Manual run' }}

            Check Zoho Projects â†’ Timesheets to confirm the entry.
